<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shadowing ç·´ç¿’å·¥å…· Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.3em;
            color: #667eea;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
        }

        input[type="text"], input[type="file"], input[type="url"], input[type="password"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        input[type="text"]:focus, input[type="url"]:focus, input[type="password"]:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: #718096;
        }

        button.danger {
            background: #e53e3e;
        }

        .player-container {
            background: #f7fafc;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: none;
        }

        .player-container.active {
            display: block;
        }

        audio {
            width: 100%;
            margin-bottom: 20px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .control-group input[type="range"] {
            width: 100%;
        }

        .control-group select {
            padding: 8px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1em;
        }

        .speed-display {
            font-weight: 600;
            color: #667eea;
            margin-top: 5px;
            font-size: 0.95em;
        }

        .transcript-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.8;
            font-size: 1.1em;
        }

        .transcript-container p {
            margin-bottom: 15px;
            color: #2d3748;
        }

        .karaoke-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white !important;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            transform: scale(1.05);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .transcript-word {
            display: inline-block;
            margin: 0 2px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .transcript-word:hover {
            background-color: #e6f7ff;
            border-radius: 3px;
            padding: 2px 4px;
        }

        .highlighted {
            background-color: #fef3c7;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .info-box {
            background: #ebf4ff;
            border-left: 4px solid #4299e1;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .info-box p, .info-box ul {
            color: #2c5282;
            line-height: 1.6;
        }

        .warning-box {
            background: #fef5e7;
            border-left: 4px solid #f39c12;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .warning-box p {
            color: #7d6608;
            line-height: 1.6;
        }

        .security-box {
            background: #f0fdf4;
            border-left: 4px solid #10b981;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .security-box p, .security-box ul {
            color: #065f46;
            line-height: 1.6;
        }

        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.95em;
        }

        .status-message.info {
            background: #e6f7ff;
            color: #0066cc;
        }

        .status-message.success {
            background: #f0f9ff;
            color: #047857;
        }

        .status-message.error {
            background: #fff1f0;
            color: #dc2626;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-radius: 0;
            color: #718096;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .tab:hover {
            color: #667eea;
            transform: none;
            box-shadow: none;
        }

        .tab.active {
            color: #667eea;
            font-weight: 600;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .api-key-display {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .api-key-display small {
            color: #10b981;
            font-weight: 500;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .content {
                padding: 20px;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ Shadowing ç·´ç¿’å·¥å…· Pro</h1>
            <p>è·Ÿè®€ç·´ç¿’ï¼Œæå‡è½èªªèƒ½åŠ›</p>
        </div>

        <div class="content">
            <div class="security-box">
                <p><strong>ğŸ”’ éš±ç§ä¿è­·ï¼š</strong></p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>ä½ çš„ API Key åªæœƒå„²å­˜åœ¨<strong>ä½ çš„ç€è¦½å™¨æœ¬åœ°</strong>ï¼Œä¸æœƒä¸Šå‚³åˆ°ä»»ä½•ä¼ºæœå™¨</li>
                    <li>å³ä½¿æ­¤ç¨‹å¼ç¢¼å…¬é–‹åœ¨ GitHubï¼Œä½ çš„ Key ä»ç„¶æ˜¯å®‰å…¨çš„</li>
                    <li>å¯éš¨æ™‚æ¸…é™¤å·²å„²å­˜çš„ API Key</li>
                </ul>
            </div>

            <!-- API Key è¨­å®šå€ -->
            <div class="section">
                <h2 class="section-title">ğŸ”‘ API è¨­å®šï¼ˆåƒ…éœ€è¨­å®šä¸€æ¬¡ï¼‰</h2>
                
                <div class="tab-container">
                    <button class="tab active" onclick="switchApiTab('openai')">OpenAI</button>
                    <button class="tab" onclick="switchApiTab('assemblyai')">AssemblyAI</button>
                </div>

                <!-- OpenAI è¨­å®š -->
                <div id="openai-api-tab" class="tab-content active">
                    <div class="input-group">
                        <label>OpenAI API Key</label>
                        <input type="password" id="openaiKey" placeholder="sk-...">
                        <div class="button-group" style="margin-top: 10px;">
                            <button onclick="saveApiKey('openai')">ğŸ’¾ å„²å­˜åˆ°æœ¬åœ°</button>
                            <button class="secondary" onclick="loadApiKey('openai')">ğŸ“¥ è¼‰å…¥å·²å„²å­˜çš„ Key</button>
                            <button class="danger" onclick="clearApiKey('openai')">ğŸ—‘ï¸ æ¸…é™¤</button>
                        </div>
                        <div id="openaiKeyStatus"></div>
                    </div>
                </div>

                <!-- AssemblyAI è¨­å®š -->
                <div id="assemblyai-api-tab" class="tab-content">
                    <div class="input-group">
                        <label>AssemblyAI API Key</label>
                        <input type="password" id="assemblyaiKey" placeholder="ä½ çš„ AssemblyAI Key">
                        <div class="button-group" style="margin-top: 10px;">
                            <button onclick="saveApiKey('assemblyai')">ğŸ’¾ å„²å­˜åˆ°æœ¬åœ°</button>
                            <button class="secondary" onclick="loadApiKey('assemblyai')">ğŸ“¥ è¼‰å…¥å·²å„²å­˜çš„ Key</button>
                            <button class="danger" onclick="clearApiKey('assemblyai')">ğŸ—‘ï¸ æ¸…é™¤</button>
                        </div>
                        <div id="assemblyaiKeyStatus"></div>
                    </div>
                </div>

                <div class="info-box" style="margin-top: 15px;">
                    <p><strong>ğŸ’¡ å¦‚ä½•å–å¾— API Keyï¼Ÿ</strong></p>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li><strong>OpenAI</strong>: <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a> (ç´„ $0.006/åˆ†é˜)</li>
                        <li><strong>AssemblyAI</strong>: <a href="https://www.assemblyai.com/" target="_blank">assemblyai.com</a> (æœ‰å…è²»é¡åº¦)</li>
                    </ul>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">ğŸ“ è¼‰å…¥éŸ³è¨Š</h2>
                
                <div class="info-box">
                    <p><strong>ğŸ’¡ æ”¯æ´å¤šç¨®ä¾†æºï¼š</strong></p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li><strong>ç›´æ¥éŸ³è¨Šç¶²å€</strong>ï¼šMP3ã€M4A ç­‰æ ¼å¼çš„ç›´æ¥é€£çµ</li>
                        <li><strong>Podcast</strong>ï¼šApple Podcastsã€Spotify ç­‰ï¼ˆéœ€è¦æ‰¾åˆ°å¯¦éš›éŸ³è¨Šæª”é€£çµï¼‰</li>
                        <li><strong>YouTube</strong>ï¼šè²¼ä¸Šå½±ç‰‡ç¶²å€ï¼Œè‡ªå‹•æå–éŸ³è¨Š</li>
                        <li><strong>æœ¬åœ°æª”æ¡ˆ</strong>ï¼šå¾é›»è…¦ä¸Šå‚³éŸ³è¨Šæª”</li>
                    </ul>
                </div>

                <div class="tab-container">
                    <button class="tab active" onclick="switchAudioTab(event, 'url')">ğŸŒ ç¶²å€</button>
                    <button class="tab" onclick="switchAudioTab(event, 'youtube')">ğŸ“º YouTube</button>
                    <button class="tab" onclick="switchAudioTab(event, 'upload')">ğŸ“ ä¸Šå‚³æª”æ¡ˆ</button>
                </div>

                <!-- ç¶²å€è¼¸å…¥ -->
                <div id="url-audio-tab" class="tab-content active">
                    <div class="input-group">
                        <label>éŸ³è¨Šç›´æ¥é€£çµï¼ˆMP3ã€M4A ç­‰ï¼‰</label>
                        <input type="url" id="audioUrl" placeholder="https://example.com/audio.mp3">
                        <small style="color: #718096; display: block; margin-top: 5px;">
                            ä¾‹å¦‚ï¼šPodcast çš„ MP3 æª”æ¡ˆé€£çµ
                        </small>
                    </div>
                    <button onclick="loadFromUrl()" class="secondary">ğŸ”— è¼‰å…¥éŸ³è¨Š</button>
                    <div id="urlStatus"></div>
                </div>

                <!-- YouTube -->
                <div id="youtube-audio-tab" class="tab-content">
                    <div class="input-group">
                        <label>YouTube å½±ç‰‡ç¶²å€</label>
                        <input type="url" id="youtubeVideoUrl" placeholder="https://www.youtube.com/watch?v=...">
                    </div>
                    <button onclick="loadFromYouTube()">ğŸ“º è¼‰å…¥ YouTube éŸ³è¨Š</button>
                    <div id="youtubeAudioStatus"></div>
                    
                    <div class="warning-box" style="margin-top: 15px;">
                        <p><strong>ğŸ’¡ æç¤ºï¼š</strong>ç”±æ–¼ç€è¦½å™¨é™åˆ¶ï¼ŒYouTube éŸ³è¨Šæå–éœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹æœå‹™ã€‚æ¨è–¦æ–¹å¼ï¼š</p>
                        <ol style="margin-left: 20px; margin-top: 10px;">
                            <li>ä½¿ç”¨ <a href="https://yt1s.com/" target="_blank">yt1s.com</a> ä¸‹è¼‰éŸ³è¨Š</li>
                            <li>ä¸‹è¼‰å¾Œåœ¨ã€Œä¸Šå‚³æª”æ¡ˆã€åˆ†é ä¸Šå‚³</li>
                        </ol>
                        <p style="margin-top: 10px;"><strong>æˆ–è€…</strong>ï¼šåœ¨ä¸‹æ–¹ã€Œé€å­—ç¨¿ã€å€ä½¿ç”¨ã€ŒYouTube å­—å¹•æå–ã€åŠŸèƒ½ï¼</p>
                    </div>
                </div>

                <!-- ä¸Šå‚³æª”æ¡ˆ -->
                <div id="upload-audio-tab" class="tab-content">
                    <div class="input-group">
                        <label>å¾é›»è…¦ä¸Šå‚³éŸ³è¨Šæª”æ¡ˆ</label>
                        <input type="file" id="audioFile" accept="audio/*">
                        <small style="color: #718096; display: block; margin-top: 5px;">
                            æ”¯æ´ï¼šMP3, M4A, WAV, OGG ç­‰æ ¼å¼
                        </small>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">ğŸ“ é€å­—ç¨¿</h2>
                
                <div class="tab-container">
                    <button class="tab active" onclick="switchTab(event, 'manual')">æ‰‹å‹•è¼¸å…¥</button>
                    <button class="tab" onclick="switchTab(event, 'auto')">è‡ªå‹•ç”¢ç”Ÿ</button>
                    <button class="tab" onclick="switchTab(event, 'youtube')">YouTube å­—å¹•</button>
                </div>

                <!-- æ‰‹å‹•è¼¸å…¥ -->
                <div id="manual-tab" class="tab-content active">
                    <div class="input-group">
                        <label>è²¼ä¸Šæˆ–è¼¸å…¥é€å­—ç¨¿å…§å®¹ï¼ˆæ¯æ®µåˆ†è¡Œï¼‰</label>
                        <textarea id="transcript" placeholder="è¼¸å…¥é€å­—ç¨¿å…§å®¹...&#10;&#10;æ¯ä¸€æ®µè½è«‹åˆ†è¡Œ&#10;é€™æ¨£å¯ä»¥æ›´å®¹æ˜“è·Ÿè‘—ç·´ç¿’"></textarea>
                    </div>
                </div>

                <!-- è‡ªå‹•ç”¢ç”Ÿ -->
                <div id="auto-tab" class="tab-content">
                    <div class="input-group">
                        <label>éŸ³è¨Šèªè¨€</label>
                        <select id="audioLanguage" style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em; width: 100%;">
                            <option value="">è‡ªå‹•åµæ¸¬ï¼ˆæ¨è–¦ï¼‰</option>
                            <option value="en">è‹±æ–‡ (English)</option>
                            <option value="zh">ä¸­æ–‡ (Chinese)</option>
                            <option value="ja">æ—¥æ–‡ (Japanese)</option>
                            <option value="ko">éŸ“æ–‡ (Korean)</option>
                            <option value="es">è¥¿ç­ç‰™æ–‡ (Spanish)</option>
                            <option value="fr">æ³•æ–‡ (French)</option>
                            <option value="de">å¾·æ–‡ (German)</option>
                            <option value="it">ç¾©å¤§åˆ©æ–‡ (Italian)</option>
                            <option value="pt">è‘¡è„ç‰™æ–‡ (Portuguese)</option>
                            <option value="ru">ä¿„æ–‡ (Russian)</option>
                            <option value="ar">é˜¿æ‹‰ä¼¯æ–‡ (Arabic)</option>
                            <option value="hi">å°åœ°æ–‡ (Hindi)</option>
                            <option value="th">æ³°æ–‡ (Thai)</option>
                            <option value="vi">è¶Šå—æ–‡ (Vietnamese)</option>
                        </select>
                        <small style="color: #718096; display: block; margin-top: 5px;">
                            å»ºè­°é¸æ“‡ã€Œè‡ªå‹•åµæ¸¬ã€ï¼ŒWhisper æœƒè‡ªå‹•åˆ¤æ–·èªè¨€
                        </small>
                    </div>
                    
                    <div class="button-group">
                        <button onclick="generateWithWhisper()" id="whisperBtn">
                            ğŸ¤– ä½¿ç”¨ Whisper ç”¢ç”Ÿé€å­—ç¨¿
                        </button>
                    </div>
                    <div id="autoStatus"></div>
                </div>

                <!-- YouTube å­—å¹• -->
                <div id="youtube-tab" class="tab-content">
                    <div class="info-box">
                        <p><strong>ğŸ’¡ å¦‚ä½•å–å¾— YouTube å­—å¹•ï¼š</strong></p>
                        <ol style="margin-left: 20px; margin-top: 10px;">
                            <li>æ‰“é–‹ YouTube å½±ç‰‡</li>
                            <li>é»æ“Šå½±ç‰‡ä¸‹æ–¹çš„ã€Œ...ã€(æ›´å¤š)</li>
                            <li>é¸æ“‡ã€Œé¡¯ç¤ºå®Œæ•´è¨˜éŒ„ã€</li>
                            <li>è¤‡è£½æ‰€æœ‰æ–‡å­—</li>
                            <li>è²¼åˆ°ä¸‹æ–¹æ–‡å­—æ¡†</li>
                        </ol>
                    </div>
                    
                    <div class="input-group">
                        <label>YouTube å½±ç‰‡ç¶²å€ï¼ˆé¸å¡«ï¼Œç”¨æ–¼è¨˜éŒ„ï¼‰</label>
                        <input type="url" id="youtubeTranscriptUrl" placeholder="https://www.youtube.com/watch?v=...">
                    </div>

                    <div class="input-group">
                        <label>è²¼ä¸Šå¾ YouTube è¤‡è£½çš„å­—å¹•</label>
                        <textarea id="youtubeTranscriptText" placeholder="å¾ YouTubeã€Œé¡¯ç¤ºå®Œæ•´è¨˜éŒ„ã€è¤‡è£½çš„æ–‡å­—..."></textarea>
                    </div>

                    <button onclick="processYouTubeTranscript()">âœ¨ è™•ç†ä¸¦ä½¿ç”¨å­—å¹•</button>
                    <div id="youtubeTranscriptStatus"></div>

                    <div class="warning-box" style="margin-top: 15px;">
                        <p><strong>æˆ–ä½¿ç”¨ç·šä¸Šå·¥å…·ï¼š</strong></p>
                        <ul style="margin-left: 20px; margin-top: 5px;">
                            <li><a href="https://downsub.com/" target="_blank">DownSub</a> - ä¸‹è¼‰å­—å¹•æª”</li>
                            <li><a href="https://youtubetranscript.com/" target="_blank">YouTube Transcript</a> - å–å¾—æ–‡å­—ç¨¿</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button onclick="loadAudio()">â–¶ï¸ é–‹å§‹ç·´ç¿’</button>
                <button onclick="resetAll()" class="secondary">ğŸ”„ é‡æ–°è¨­å®š</button>
            </div>

            <div class="player-container" id="playerContainer">
                <!-- æ’­æ”¾æ§åˆ¶å€ -->
                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">ğŸµ æ’­æ”¾æ§åˆ¶</h3>
                    
                    <audio id="audioPlayer" style="display: none;">
                        æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´éŸ³è¨Šæ’­æ”¾ã€‚
                    </audio>
                    
                    <div class="button-group" style="margin-bottom: 15px;">
                        <button onclick="togglePlay()" id="playBtn" style="font-size: 1.2em; padding: 15px 30px;">
                            â–¶ï¸ æ’­æ”¾
                        </button>
                        <button onclick="toggleRecord()" id="recordBtn" style="background: #e53e3e; font-size: 1.2em; padding: 15px 30px;">
                            ğŸ¤ é–‹å§‹éŒ„éŸ³
                        </button>
                        <button onclick="playRecording()" id="playRecordBtn" style="background: #10b981; display: none; font-size: 1.2em; padding: 15px 30px;">
                            ğŸ”Š æ’­æ”¾éŒ„éŸ³
                        </button>
                        <button onclick="compareAudio()" id="compareBtn" style="background: #f59e0b; display: none; font-size: 1.2em; padding: 15px 30px;">
                            ğŸ“Š æ¯”å°ç™¼éŸ³
                        </button>
                    </div>
                    
                    <!-- é€²åº¦æ¢ -->
                    <div style="margin-bottom: 15px;">
                        <input type="range" id="progressBar" min="0" max="100" value="0" 
                               style="width: 100%; height: 8px; cursor: pointer;"
                               oninput="seekAudio(this.value)">
                        <div style="display: flex; justify-content: space-between; font-size: 0.9em; color: #718096;">
                            <span id="currentTime">0:00</span>
                            <span id="duration">0:00</span>
                        </div>
                    </div>
                    
                    <div id="recordingStatus" style="margin-top: 10px;"></div>
                </div>

                <div class="controls">
                    <div class="control-group">
                        <label>æ’­æ”¾é€Ÿåº¦</label>
                        <input type="range" id="speedControl" min="0.5" max="2" step="0.1" value="1">
                        <div class="speed-display" id="speedDisplay">1.0x</div>
                    </div>

                    <div class="control-group">
                        <label>å¾ªç’°æ’­æ”¾å€é–“</label>
                        <select id="loopSelect" onchange="updateLoopTimes()">
                            <option value="none">é—œé–‰å¾ªç’°</option>
                            <option value="5">æ¯ 5 ç§’å¾ªç’°</option>
                            <option value="10">æ¯ 10 ç§’å¾ªç’°</option>
                            <option value="15">æ¯ 15 ç§’å¾ªç’°</option>
                            <option value="30">æ¯ 30 ç§’å¾ªç’°</option>
                            <option value="custom">è‡ªè¨‚å€é–“</option>
                        </select>
                    </div>

                    <div class="control-group" id="customLoopGroup" style="display: none;">
                        <label>è‡ªè¨‚é–‹å§‹æ™‚é–“ï¼ˆç§’ï¼‰</label>
                        <input type="number" id="loopStart" min="0" step="1" value="0">
                    </div>

                    <div class="control-group" id="customLoopEndGroup" style="display: none;">
                        <label>è‡ªè¨‚çµæŸæ™‚é–“ï¼ˆç§’ï¼‰</label>
                        <input type="number" id="loopEnd" min="0" step="1" value="10">
                    </div>
                    
                    <div class="control-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="karaokeMode" onchange="toggleKaraokeMode()" 
                                   style="width: auto; height: 20px;">
                            å¡æ‹‰ OK æ¨¡å¼
                        </label>
                        <small style="color: #718096; margin-top: 5px; display: block;">
                            å­—å¹•æœƒéš¨è‘—éŸ³è¨Šé«˜äº®è®Šè‰²
                        </small>
                        <small style="color: #f59e0b; margin-top: 3px; display: block; font-weight: 500;" id="karaokeHint">
                            ğŸ’¡ ä½¿ç”¨ Whisper API ç”¢ç”Ÿé€å­—ç¨¿å¯ç²å¾—ç²¾ç¢ºåŒæ­¥
                        </small>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">ğŸ“– é€å­—ç¨¿å…§å®¹</h2>
                    <div class="transcript-container" id="transcriptDisplay"></div>
                </div>
                
                <!-- æ¯”å°è¦–è¦ºåŒ–å€ -->
                <div id="comparisonSection" style="display: none; margin-top: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ“Š ç™¼éŸ³æ¯”å°</h3>
                    <div style="background: white; padding: 20px; border-radius: 12px;">
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #4a5568; margin-bottom: 10px;">åŸéŸ³æ³¢å½¢</h4>
                            <canvas id="originalWaveform" width="800" height="100" style="width: 100%; border: 1px solid #e2e8f0; border-radius: 4px;"></canvas>
                        </div>
                        <div>
                            <h4 style="color: #4a5568; margin-bottom: 10px;">ä½ çš„éŒ„éŸ³æ³¢å½¢</h4>
                            <canvas id="recordingWaveform" width="800" height="100" style="width: 100%; border: 1px solid #e2e8f0; border-radius: 4px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let audio = document.getElementById('audioPlayer');
        let currentLoopMode = 'none';
        let mediaRecorder = null;
        let recordedChunks = [];
        let recordedBlob = null;
        let isRecording = false;
        let karaokeEnabled = false;
        let transcriptWords = [];
        let karaokeInterval = null;

        // API Key ç®¡ç†
        function saveApiKey(provider) {
            const keyInput = provider === 'openai' ? 
                document.getElementById('openaiKey') : 
                document.getElementById('assemblyaiKey');
            const key = keyInput.value.trim();
            
            if (!key) {
                alert('è«‹è¼¸å…¥ API Keyï¼');
                return;
            }

            // å„²å­˜åˆ° localStorageï¼ˆåªå­˜åœ¨ç”¨æˆ¶ç€è¦½å™¨ï¼‰
            localStorage.setItem(`${provider}_api_key`, key);
            
            const statusDiv = document.getElementById(`${provider}KeyStatus`);
            showStatus(statusDiv, 'success', `âœ… API Key å·²å®‰å…¨å„²å­˜åˆ°ä½ çš„ç€è¦½å™¨æœ¬åœ°ï¼`);
            
            // æ¸…ç©ºè¼¸å…¥æ¡†ï¼ˆå®‰å…¨è€ƒé‡ï¼‰
            keyInput.value = '';
        }

        function loadApiKey(provider) {
            const key = localStorage.getItem(`${provider}_api_key`);
            const statusDiv = document.getElementById(`${provider}KeyStatus`);
            
            if (key) {
                const keyInput = provider === 'openai' ? 
                    document.getElementById('openaiKey') : 
                    document.getElementById('assemblyaiKey');
                keyInput.value = key;
                showStatus(statusDiv, 'success', 'âœ… å·²è¼‰å…¥å·²å„²å­˜çš„ API Key');
            } else {
                showStatus(statusDiv, 'error', 'âŒ æ²’æœ‰æ‰¾åˆ°å·²å„²å­˜çš„ API Key');
            }
        }

        function clearApiKey(provider) {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤å·²å„²å­˜çš„ API Key å—ï¼Ÿ')) {
                localStorage.removeItem(`${provider}_api_key`);
                const keyInput = provider === 'openai' ? 
                    document.getElementById('openaiKey') : 
                    document.getElementById('assemblyaiKey');
                keyInput.value = '';
                
                const statusDiv = document.getElementById(`${provider}KeyStatus`);
                showStatus(statusDiv, 'info', 'ğŸ—‘ï¸ API Key å·²æ¸…é™¤');
            }
        }

        // åˆ‡æ› API åˆ†é 
        function switchApiTab(tabName) {
            document.querySelectorAll('#openai-api-tab, #assemblyai-api-tab').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-api-tab').classList.add('active');
        }

        // åˆ‡æ›éŸ³è¨Šä¾†æºåˆ†é 
        function switchAudioTab(e, tabName) {
            // ç§»é™¤æ‰€æœ‰åˆ†é æŒ‰éˆ•çš„ active
            const audioTabs = document.querySelectorAll('.tab-container .tab');
            audioTabs.forEach(tab => {
                // åªç§»é™¤éŸ³è¨Šå€çš„åˆ†é 
                if (tab.onclick && tab.onclick.toString().includes('switchAudioTab')) {
                    tab.classList.remove('active');
                }
            });
            e.target.classList.add('active');

            // åˆ‡æ›å…§å®¹å€
            document.querySelectorAll('#url-audio-tab, #youtube-audio-tab, #upload-audio-tab').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-audio-tab').classList.add('active');
        }

        // åˆ‡æ›é€å­—ç¨¿åˆ†é 
        function switchTab(e, tabName) {
            // ç§»é™¤æ‰€æœ‰é€å­—ç¨¿åˆ†é æŒ‰éˆ•çš„ active
            const transcriptTabs = e.target.parentElement.querySelectorAll('.tab');
            transcriptTabs.forEach(tab => {
                tab.classList.remove('active');
            });
            e.target.classList.add('active');

            // åˆ‡æ›å…§å®¹å€
            document.querySelectorAll('#manual-tab, #auto-tab, #youtube-tab').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // å¾ç¶²å€è¼‰å…¥éŸ³è¨Š
        function loadFromUrl() {
            const audioUrl = document.getElementById('audioUrl').value.trim();
            const statusDiv = document.getElementById('urlStatus');

            if (!audioUrl) {
                showStatus(statusDiv, 'error', 'âŒ è«‹è¼¸å…¥éŸ³è¨Šç¶²å€');
                return;
            }

            try {
                audio.src = audioUrl;
                showStatus(statusDiv, 'success', 'âœ… éŸ³è¨Šå·²è¼‰å…¥ï¼ç¾åœ¨å¯ä»¥è¨­å®šé€å­—ç¨¿ä¸¦é–‹å§‹ç·´ç¿’');
            } catch (error) {
                showStatus(statusDiv, 'error', 'âŒ è¼‰å…¥å¤±æ•—ï¼š' + error.message);
            }
        }

        // å¾ YouTube è¼‰å…¥ï¼ˆæç¤ºç”¨æˆ¶ä½¿ç”¨å·¥å…·ï¼‰
        function loadFromYouTube() {
            const youtubeUrl = document.getElementById('youtubeVideoUrl').value.trim();
            const statusDiv = document.getElementById('youtubeAudioStatus');

            if (!youtubeUrl) {
                showStatus(statusDiv, 'error', 'âŒ è«‹è¼¸å…¥ YouTube å½±ç‰‡ç¶²å€');
                return;
            }

            if (!youtubeUrl.includes('youtube.com') && !youtubeUrl.includes('youtu.be')) {
                showStatus(statusDiv, 'error', 'âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„ YouTube ç¶²å€');
                return;
            }

            showStatus(statusDiv, 'info', 
                'ğŸ’¡ ç”±æ–¼ç€è¦½å™¨é™åˆ¶ï¼Œè«‹ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ï¼š<br>' +
                '1. ä½¿ç”¨ <a href="https://yt1s.com/" target="_blank" style="color: #667eea;">yt1s.com</a> ä¸‹è¼‰éŸ³è¨Š<br>' +
                '2. åœ¨ã€Œä¸Šå‚³æª”æ¡ˆã€åˆ†é ä¸Šå‚³éŸ³è¨Š<br>' +
                '3. åœ¨ã€Œé€å­—ç¨¿ã€â†’ã€ŒYouTube å­—å¹•ã€æå–å­—å¹•'
            );
        }

        // è™•ç† YouTube å­—å¹•
        function processYouTubeTranscript() {
            const transcriptText = document.getElementById('youtubeTranscriptText').value.trim();
            const statusDiv = document.getElementById('youtubeTranscriptStatus');

            if (!transcriptText) {
                showStatus(statusDiv, 'error', 'âŒ è«‹è²¼ä¸Š YouTube å­—å¹•å…§å®¹');
                return;
            }

            // æ¸…ç† YouTube å­—å¹•æ ¼å¼ï¼ˆç§»é™¤æ™‚é–“æˆ³è¨˜ï¼‰
            let cleaned = transcriptText
                // ç§»é™¤æ™‚é–“æˆ³ (ä¾‹å¦‚: 0:00, 1:23)
                .replace(/\d+:\d+/g, '')
                // ç§»é™¤å¤šé¤˜ç©ºç™½
                .replace(/\s+/g, ' ')
                // æŒ‰å¥è™Ÿåˆ†æ®µ
                .split(/[.!?]+/)
                .map(s => s.trim())
                .filter(s => s.length > 0)
                .join('\n');

            // æ”¾åˆ°ä¸»è¦é€å­—ç¨¿å€
            document.getElementById('transcript').value = cleaned;
            
            showStatus(statusDiv, 'success', 'âœ… å­—å¹•å·²è™•ç†ä¸¦è¼‰å…¥ï¼å¯ä»¥é–‹å§‹ç·´ç¿’äº†');
            
            // åˆ‡æ›åˆ°æ‰‹å‹•è¼¸å…¥åˆ†é é¡¯ç¤ºçµæœ
            setTimeout(() => {
                switchToManualTab();
            }, 500);
        }

        // åˆ‡æ›åˆ°æ‰‹å‹•è¼¸å…¥åˆ†é ï¼ˆç¨‹å¼åŒ–ï¼‰
        function switchToManualTab() {
            // ç§»é™¤æ‰€æœ‰é€å­—ç¨¿åˆ†é çš„ active
            document.querySelectorAll('#manual-tab, #auto-tab, #youtube-tab').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('manual-tab').classList.add('active');
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            const tabContainer = document.querySelector('.tab-container');
            const tabs = Array.from(tabContainer.querySelectorAll('.tab'));
            tabs.forEach(tab => {
                if (tab.onclick && tab.onclick.toString().includes('manual')) {
                    tab.classList.add('active');
                } else if (tab.onclick && (tab.onclick.toString().includes('auto') || tab.onclick.toString().includes('youtube'))) {
                    tab.classList.remove('active');
                }
            });
        }

        // è¼‰å…¥éŸ³è¨Š
        function loadAudio() {
            const audioUrl = document.getElementById('audioUrl').value.trim();
            const audioFile = document.getElementById('audioFile').files[0];
            const transcriptText = document.getElementById('transcript').value.trim();

            if (!transcriptText) {
                alert('è«‹è¼¸å…¥æˆ–ç”¢ç”Ÿé€å­—ç¨¿å…§å®¹ï¼');
                return;
            }

            if (audioUrl) {
                audio.src = audioUrl;
            } else if (audioFile) {
                audio.src = URL.createObjectURL(audioFile);
            } else {
                alert('è«‹æä¾›éŸ³è¨Šç¶²å€æˆ–ä¸Šå‚³éŸ³è¨Šæª”æ¡ˆï¼');
                return;
            }

            document.getElementById('playerContainer').classList.add('active');
            displayTranscript(transcriptText);
            document.getElementById('playerContainer').scrollIntoView({ behavior: 'smooth' });
            
            // å¦‚æœæ²’æœ‰æ™‚é–“æˆ³è¨˜ï¼Œé¡¯ç¤ºæç¤º
            if (!window.transcriptTimestamps) {
                console.log('æç¤ºï¼šä½¿ç”¨ Whisper API è‡ªå‹•ç”¢ç”Ÿé€å­—ç¨¿å¯ç²å¾—ç²¾ç¢ºçš„å¡æ‹‰OKåŒæ­¥æ•ˆæœ');
            }
        }

        // é¡¯ç¤ºé€å­—ç¨¿
        function displayTranscript(text) {
            const container = document.getElementById('transcriptDisplay');
            
            // å¦‚æœæœ‰æ™‚é–“æˆ³è¨˜è³‡æ–™ï¼Œä½¿ç”¨ç²¾ç¢ºæ¨¡å¼
            if (window.transcriptTimestamps && window.transcriptTimestamps.length > 0) {
                const wordsHtml = window.transcriptTimestamps.map((wordData, index) => {
                    return `<span class="transcript-word" 
                                  data-index="${index}" 
                                  data-start="${wordData.start}" 
                                  data-end="${wordData.end}">${wordData.word}</span>`;
                }).join(' ');
                container.innerHTML = `<p>${wordsHtml}</p>`;
            } else {
                // æ²’æœ‰æ™‚é–“æˆ³è¨˜ï¼Œä½¿ç”¨åŸºæœ¬æ¨¡å¼
                const paragraphs = text.split('\n').filter(p => p.trim());
                const wordsHtml = paragraphs.map((p, pIndex) => {
                    const words = p.split(/(\s+)/).filter(w => w.trim());
                    const wordSpans = words.map((word, wIndex) => {
                        return `<span class="transcript-word" data-index="${pIndex}-${wIndex}">${word}</span>`;
                    }).join(' ');
                    return `<p>${wordSpans}</p>`;
                }).join('');
                container.innerHTML = wordsHtml;
            }
            
            // å„²å­˜å–®è©å…ƒç´ ä¾›å¡æ‹‰OKä½¿ç”¨
            transcriptWords = Array.from(container.querySelectorAll('.transcript-word'));
        }

        // æ’­æ”¾/æš«åœæ§åˆ¶
        function togglePlay() {
            const btn = document.getElementById('playBtn');
            if (audio.paused) {
                audio.play();
                btn.textContent = 'â¸ï¸ æš«åœ';
            } else {
                audio.pause();
                btn.textContent = 'â–¶ï¸ æ’­æ”¾';
            }
        }

        // é€²åº¦æ¢æ§åˆ¶
        function seekAudio(value) {
            const time = (value / 100) * audio.duration;
            audio.currentTime = time;
        }

        // æ›´æ–°é€²åº¦æ¢å’Œæ™‚é–“é¡¯ç¤º
        audio.addEventListener('timeupdate', function() {
            const progress = (audio.currentTime / audio.duration) * 100;
            document.getElementById('progressBar').value = progress || 0;
            
            document.getElementById('currentTime').textContent = formatTime(audio.currentTime);
            document.getElementById('duration').textContent = formatTime(audio.duration);
            
            // å¡æ‹‰OKæ•ˆæœ
            if (karaokeEnabled) {
                updateKaraoke();
            }
            
            // å¾ªç’°æ’­æ”¾é‚è¼¯
            if (currentLoopMode !== 'none' && currentLoopMode !== 'custom') {
                const interval = parseInt(currentLoopMode);
                const currentTime = audio.currentTime;
                const segmentStart = Math.floor(currentTime / interval) * interval;
                const segmentEnd = segmentStart + interval;
                if (currentTime >= segmentEnd) {
                    audio.currentTime = segmentStart;
                }
            } else if (currentLoopMode === 'custom') {
                const start = parseFloat(document.getElementById('loopStart').value) || 0;
                const end = parseFloat(document.getElementById('loopEnd').value) || 10;
                if (audio.currentTime >= end) {
                    audio.currentTime = start;
                }
            }
        });

        // éŸ³è¨Šæ’­æ”¾çµæŸ
        audio.addEventListener('ended', function() {
            document.getElementById('playBtn').textContent = 'â–¶ï¸ æ’­æ”¾';
        });

        // éŸ³è¨Šè¼‰å…¥å®Œæˆ
        audio.addEventListener('loadedmetadata', function() {
            document.getElementById('duration').textContent = formatTime(audio.duration);
        });

        // æ ¼å¼åŒ–æ™‚é–“
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // å¡æ‹‰OKæ¨¡å¼
        function toggleKaraokeMode() {
            karaokeEnabled = document.getElementById('karaokeMode').checked;
            const hint = document.getElementById('karaokeHint');
            
            if (!karaokeEnabled) {
                // ç§»é™¤æ‰€æœ‰é«˜äº®
                transcriptWords.forEach(word => {
                    word.classList.remove('karaoke-active');
                    word.style.opacity = '1';
                });
            } else {
                // æ›´æ–°æç¤º
                if (window.transcriptTimestamps) {
                    hint.textContent = 'âœ… å·²å•Ÿç”¨ç²¾ç¢ºåŒæ­¥æ¨¡å¼';
                    hint.style.color = '#10b981';
                } else {
                    hint.textContent = 'âš ï¸ ä½¿ç”¨ç°¡å–®æ¨¡å¼ï¼ˆå»ºè­°ç”¨ Whisper API ç”¢ç”Ÿé€å­—ç¨¿ç²å¾—ç²¾ç¢ºåŒæ­¥ï¼‰';
                    hint.style.color = '#f59e0b';
                }
            }
        }

        function updateKaraoke() {
            if (!karaokeEnabled || transcriptWords.length === 0) return;
            
            const currentTime = audio.currentTime;
            
            // å¦‚æœæœ‰ç²¾ç¢ºçš„æ™‚é–“æˆ³è¨˜ï¼Œä½¿ç”¨å®ƒå€‘
            if (window.transcriptTimestamps && window.transcriptTimestamps.length > 0) {
                transcriptWords.forEach((wordElement, index) => {
                    const start = parseFloat(wordElement.dataset.start);
                    const end = parseFloat(wordElement.dataset.end);
                    
                    if (currentTime >= start && currentTime <= end) {
                        // ç•¶å‰æ­£åœ¨èªªçš„å–®è©
                        wordElement.classList.add('karaoke-active');
                        wordElement.style.opacity = '1';
                        // è‡ªå‹•æ»¾å‹•
                        wordElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else if (currentTime > end) {
                        // å·²ç¶“èªªéçš„å–®è©
                        wordElement.classList.remove('karaoke-active');
                        wordElement.style.opacity = '0.5';
                    } else {
                        // é‚„æ²’èªªåˆ°çš„å–®è©
                        wordElement.classList.remove('karaoke-active');
                        wordElement.style.opacity = '1';
                    }
                });
            } else {
                // æ²’æœ‰æ™‚é–“æˆ³è¨˜ï¼Œä½¿ç”¨ç°¡å–®çš„æ¯”ä¾‹è¨ˆç®—
                const duration = audio.duration;
                const progress = currentTime / duration;
                const activeIndex = Math.floor(progress * transcriptWords.length);
                
                transcriptWords.forEach((word, index) => {
                    if (index === activeIndex) {
                        word.classList.add('karaoke-active');
                        word.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else if (index < activeIndex) {
                        word.classList.remove('karaoke-active');
                        word.style.opacity = '0.6';
                    } else {
                        word.classList.remove('karaoke-active');
                        word.style.opacity = '1';
                    }
                });
            }
        }

        // éŒ„éŸ³åŠŸèƒ½
        async function toggleRecord() {
            const btn = document.getElementById('recordBtn');
            const statusDiv = document.getElementById('recordingStatus');
            
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    recordedChunks = [];
                    
                    mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) {
                            recordedChunks.push(e.data);
                        }
                    };
                    
                    mediaRecorder.onstop = () => {
                        recordedBlob = new Blob(recordedChunks, { type: 'audio/webm' });
                        document.getElementById('playRecordBtn').style.display = 'inline-block';
                        document.getElementById('compareBtn').style.display = 'inline-block';
                        showStatus(statusDiv, 'success', 'âœ… éŒ„éŸ³å®Œæˆï¼å¯ä»¥æ’­æ”¾æˆ–æ¯”å°');
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    btn.textContent = 'â¹ï¸ åœæ­¢éŒ„éŸ³';
                    btn.style.background = '#f59e0b';
                    showStatus(statusDiv, 'info', 'ğŸ¤ éŒ„éŸ³ä¸­...');
                    
                    // åŒæ™‚æ’­æ”¾åŸéŸ³
                    audio.currentTime = 0;
                    audio.play();
                    document.getElementById('playBtn').textContent = 'â¸ï¸ æš«åœ';
                    
                } catch (error) {
                    showStatus(statusDiv, 'error', 'âŒ ç„¡æ³•å­˜å–éº¥å…‹é¢¨ï¼š' + error.message);
                }
            } else {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                btn.textContent = 'ğŸ¤ é–‹å§‹éŒ„éŸ³';
                btn.style.background = '#e53e3e';
                
                // åœæ­¢åŸéŸ³æ’­æ”¾
                audio.pause();
                document.getElementById('playBtn').textContent = 'â–¶ï¸ æ’­æ”¾';
            }
        }

        // æ’­æ”¾éŒ„éŸ³
        function playRecording() {
            if (recordedBlob) {
                const audioUrl = URL.createObjectURL(recordedBlob);
                const recordAudio = new Audio(audioUrl);
                recordAudio.play();
            }
        }

        // æ¯”å°éŸ³è¨Š
        async function compareAudio() {
            if (!recordedBlob) return;
            
            document.getElementById('comparisonSection').style.display = 'block';
            
            // ç¹ªè£½æ³¢å½¢
            await drawWaveform(audio.src, 'originalWaveform', '#667eea');
            await drawWaveform(URL.createObjectURL(recordedBlob), 'recordingWaveform', '#e53e3e');
            
            // æ»¾å‹•åˆ°æ¯”å°å€
            document.getElementById('comparisonSection').scrollIntoView({ behavior: 'smooth' });
        }

        // ç¹ªè£½æ³¢å½¢
        async function drawWaveform(audioSrc, canvasId, color) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // æ¸…ç©ºç•«å¸ƒ
            ctx.clearRect(0, 0, width, height);
            
            try {
                // è¼‰å…¥éŸ³è¨Š
                const response = await fetch(audioSrc);
                const arrayBuffer = await response.arrayBuffer();
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                const data = audioBuffer.getChannelData(0);
                const step = Math.ceil(data.length / width);
                const amp = height / 2;
                
                ctx.fillStyle = color;
                ctx.beginPath();
                
                for (let i = 0; i < width; i++) {
                    let min = 1.0;
                    let max = -1.0;
                    
                    for (let j = 0; j < step; j++) {
                        const datum = data[(i * step) + j];
                        if (datum < min) min = datum;
                        if (datum > max) max = datum;
                    }
                    
                    const yMin = (1 + min) * amp;
                    const yMax = (1 + max) * amp;
                    
                    ctx.fillRect(i, yMin, 1, yMax - yMin);
                }
                
            } catch (error) {
                console.error('ç¹ªè£½æ³¢å½¢å¤±æ•—:', error);
                ctx.fillStyle = '#cbd5e0';
                ctx.fillRect(0, height / 2 - 2, width, 4);
                ctx.fillStyle = '#4a5568';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('ç„¡æ³•è¼‰å…¥æ³¢å½¢', width / 2, height / 2 + 20);
            }
        }

        // ä½¿ç”¨ Whisper API ç”¢ç”Ÿé€å­—ç¨¿
        async function generateWithWhisper() {
            // å¾ localStorage è®€å– API Key
            const apiKey = localStorage.getItem('openai_api_key');
            const audioFile = document.getElementById('audioFile').files[0];
            const language = document.getElementById('audioLanguage').value;
            const statusDiv = document.getElementById('autoStatus');

            if (!apiKey) {
                showStatus(statusDiv, 'error', 'âŒ è«‹å…ˆåœ¨ä¸Šæ–¹è¨­å®šä¸¦å„²å­˜ OpenAI API Key');
                return;
            }

            if (!audioFile) {
                showStatus(statusDiv, 'error', 'âŒ è«‹å…ˆä¸Šå‚³éŸ³è¨Šæª”æ¡ˆ');
                return;
            }

            const btn = document.getElementById('whisperBtn');
            btn.disabled = true;
            btn.textContent = 'â³ è™•ç†ä¸­...';
            
            const langText = language ? getLanguageName(language) : 'è‡ªå‹•åµæ¸¬';
            showStatus(statusDiv, 'info', `æ­£åœ¨ä½¿ç”¨ ${langText} è½‰éŒ„éŸ³è¨Šä¸¦ç”Ÿæˆæ™‚é–“æˆ³ï¼Œé€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜...`);

            try {
                const formData = new FormData();
                formData.append('file', audioFile);
                formData.append('model', 'whisper-1');
                formData.append('response_format', 'verbose_json');
                formData.append('timestamp_granularities[]', 'word');
                
                // åªæœ‰åœ¨æŒ‡å®šèªè¨€æ™‚æ‰åŠ å…¥ language åƒæ•¸
                // ä¸æŒ‡å®šæ™‚ Whisper æœƒè‡ªå‹•åµæ¸¬
                if (language) {
                    formData.append('language', language);
                }

                const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'è½‰éŒ„å¤±æ•—');
                }

                const result = await response.json();
                
                // å„²å­˜æ™‚é–“æˆ³è¨˜è³‡æ–™
                if (result.words) {
                    window.transcriptTimestamps = result.words;
                    console.log('å·²ç²å–å–®è©æ™‚é–“æˆ³:', result.words);
                    showStatus(statusDiv, 'success', 'âœ… é€å­—ç¨¿å’Œæ™‚é–“æˆ³ç”¢ç”ŸæˆåŠŸï¼å¡æ‹‰OKæ¨¡å¼ç¾åœ¨æœƒç²¾ç¢ºåŒæ­¥');
                } else {
                    window.transcriptTimestamps = null;
                    showStatus(statusDiv, 'success', 'âœ… é€å­—ç¨¿ç”¢ç”ŸæˆåŠŸï¼ï¼ˆæœªåŒ…å«æ™‚é–“æˆ³ï¼‰');
                }
                
                document.getElementById('transcript').value = result.text;
                
                // è‡ªå‹•åˆ‡æ›åˆ°æ‰‹å‹•è¼¸å…¥åˆ†é 
                switchToManualTab();

            } catch (error) {
                showStatus(statusDiv, 'error', 'âŒ éŒ¯èª¤: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ¤– ä½¿ç”¨ Whisper ç”¢ç”Ÿé€å­—ç¨¿';
            }
        }

        // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
        function showStatus(container, type, message) {
            container.innerHTML = `<div class="status-message ${type}">${message}</div>`;
        }

        // å–å¾—èªè¨€åç¨±
        function getLanguageName(code) {
            const languages = {
                'en': 'è‹±æ–‡',
                'zh': 'ä¸­æ–‡',
                'ja': 'æ—¥æ–‡',
                'ko': 'éŸ“æ–‡',
                'es': 'è¥¿ç­ç‰™æ–‡',
                'fr': 'æ³•æ–‡',
                'de': 'å¾·æ–‡',
                'it': 'ç¾©å¤§åˆ©æ–‡',
                'pt': 'è‘¡è„ç‰™æ–‡',
                'ru': 'ä¿„æ–‡',
                'ar': 'é˜¿æ‹‰ä¼¯æ–‡',
                'hi': 'å°åœ°æ–‡',
                'th': 'æ³°æ–‡',
                'vi': 'è¶Šå—æ–‡'
            };
            return languages[code] || code;
        }

        // é€Ÿåº¦æ§åˆ¶
        document.getElementById('speedControl').addEventListener('input', function() {
            const speed = parseFloat(this.value);
            audio.playbackRate = speed;
            document.getElementById('speedDisplay').textContent = speed.toFixed(1) + 'x';
        });

        // æ›´æ–°å¾ªç’°è¨­å®š
        function updateLoopTimes() {
            const loopSelect = document.getElementById('loopSelect');
            const value = loopSelect.value;
            currentLoopMode = value;

            const customGroup = document.getElementById('customLoopGroup');
            const customEndGroup = document.getElementById('customLoopEndGroup');

            if (value === 'custom') {
                customGroup.style.display = 'block';
                customEndGroup.style.display = 'block';
            } else {
                customGroup.style.display = 'none';
                customEndGroup.style.display = 'none';
            }
        }

        // éŸ³è¨Šæ™‚é–“æ›´æ–°äº‹ä»¶
        audio.addEventListener('timeupdate', function() {
            if (currentLoopMode !== 'none' && currentLoopMode !== 'custom') {
                const interval = parseInt(currentLoopMode);
                const currentTime = audio.currentTime;
                
                const segmentStart = Math.floor(currentTime / interval) * interval;
                const segmentEnd = segmentStart + interval;

                if (currentTime >= segmentEnd) {
                    audio.currentTime = segmentStart;
                }
            } else if (currentLoopMode === 'custom') {
                const start = parseFloat(document.getElementById('loopStart').value) || 0;
                const end = parseFloat(document.getElementById('loopEnd').value) || 10;
                
                if (audio.currentTime >= end) {
                    audio.currentTime = start;
                }
            }
        });

        // é‡æ–°è¨­å®š
        function resetAll() {
            document.getElementById('audioUrl').value = '';
            document.getElementById('audioFile').value = '';
            document.getElementById('transcript').value = '';
            document.getElementById('playerContainer').classList.remove('active');
            audio.pause();
            audio.src = '';
            document.getElementById('speedControl').value = 1;
            document.getElementById('speedDisplay').textContent = '1.0x';
            document.getElementById('loopSelect').value = 'none';
            currentLoopMode = 'none';
            updateLoopTimes();
            document.getElementById('autoStatus').innerHTML = '';
        }

        // éµç›¤å¿«æ·éµ
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space' && audio.src) {
                e.preventDefault();
                if (audio.paused) {
                    audio.play();
                } else {
                    audio.pause();
                }
            }
            
            if (e.code === 'ArrowLeft' && audio.src) {
                e.preventDefault();
                audio.currentTime = Math.max(0, audio.currentTime - 5);
            }
            
            if (e.code === 'ArrowRight' && audio.src) {
                e.preventDefault();
                audio.currentTime = Math.min(audio.duration, audio.currentTime + 5);
            }
        });

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥æ˜¯å¦æœ‰å„²å­˜çš„ API Key
        window.addEventListener('load', function() {
            const openaiKey = localStorage.getItem('openai_api_key');
            const assemblyaiKey = localStorage.getItem('assemblyai_api_key');
            
            if (openaiKey) {
                showStatus(document.getElementById('openaiKeyStatus'), 'success', 
                    'âœ… å·²æœ‰å„²å­˜çš„ OpenAI API Key');
            }
            
            if (assemblyaiKey) {
                showStatus(document.getElementById('assemblyaiKeyStatus'), 'success', 
                    'âœ… å·²æœ‰å„²å­˜çš„ AssemblyAI API Key');
            }
        });
    </script>
</body>
</html>
